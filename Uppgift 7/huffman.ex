defmodule Huffman do

  def sample do
      #'Första kapitlet
      #Den bok jag nu sätter mig ner att skriva måste verka meningslös på många - om jag alls vågar tänka mig, att "många" får läsa den - eftersom jag alldeles självmant, utan någons order, börjar ett sådant arbete och ändå inte själv är riktigt på det klara med vad avsikten är. Jag vill och måste, det är alltsammans. Allt mer och mer obönhörligt frågar man efter avsikten och planmässigheten i vad som göres och säges, så att helst inte ett ord ska falla på måfå - det är bara författaren till den här boken som har tvingats gå motsatta vägen, ut i det ändamålslösa. Ty fast mina år här som fånge och kemist - de måste vara över tjugu, tänker jag mig - har varit fulla nog ändå av arbete och brådska, måste det finnas något som inte tycker det är tillräckligt och som har lett och överblickat ett annat arbete inom mig, ett som jag själv inte hade någon möjlighet att överblicka och där jag ändå har varit djupt och nästan plågsamt medintresserad. Det arbetet kommer att vara slutfört, när jag väl har skrivit ner min bok. Jag inser alltså, hur förnuftsvidriga mina skriverier måste te sig inför allt rationellt och praktiskt tänkande, men jag skriver ändå.
      #Kanske jag inte skulle vågat det förr. Kanske det rentav är fångenskapen, som har gjort mig lättsinnig. Mina levnadsvillkor nu skiljer sig obetydligt från dem jag levde under som fri man. Maten visade sig vara knappt märkbart sämre här - det vande man sig vid. Britsen visade sig vara något hårdare än min säng hemma i Kemistaden n:r 4 - det vande man sig vid. Jag kom något mera sällan ut i fria luften - det vande man sig också vid. Värst var skilsmässan från min hustru och mina barn, särskilt som jag ingenting visste eller vet om deras öde; det gjorde mina första år i fångenskapen fulla av oro och ångest. Men allteftersom tiden led, började jag känna mig lugnare än förr och till och med trivas mer och mer med min tillvaro. Här hade jag ingenting att vara ängslig för. Jag hade varken underordnade eller chefer - så när som på fängelsevakterna, som sällan störde mitt arbete och bara bekymrade sig om att jag efterlevde ordningsreglerna. Jag hade varken beskyddare eller medtävlare. De vetenskapsmän jag ibland sammanfördes med för att kunna följa med nya rön på kemins område, behandlade mig hövligt och sakligt, om än något nedlåtande för min främmande nationalitets skull. Jag visste, att ingen ansåg sig ha skäl att avundas mig. Kort sagt: på sätt och vis kunde jag känna mig friare än i friheten. Men på samma gång som lugnet växte också detta underliga arbete med det förflutna inom mig, och nu får jag ingen ro förrän jag har skrivit ner mina minnen från en viss innehållsrik tid i mitt liv. Möjlighet att skriva har man givit mig för mitt vetenskapliga arbetes skull, och kontroll utövas först i det ögonblick jag lämnar ett färdigt arbete.'

      #'Första kapitlet
      #Den bok jag nu sätter mig ner att skriva måste verka meningslös på många - om jag alls vågar tänka mig, att "många" får läsa den - eftersom jag alldeles självmant, utan någons order, börjar ett sådant arbete och ändå inte själv är riktigt på det klara med vad avsikten är. Jag vill och måste, det är alltsammans. Allt mer och mer obönhörligt frågar man efter avsikten och planmässigheten i vad som göres och säges, så att helst inte ett ord ska falla på måfå - det är bara författaren till den här boken som har tvingats gå motsatta vägen, ut i det ändamålslösa. Ty fast mina år här som fånge och kemist - de måste vara över tjugu, tänker jag mig - har varit fulla nog ändå av arbete och brådska, måste det finnas något som inte tycker det är tillräckligt och som har lett och överblickat ett annat arbete inom mig, ett som jag själv inte hade någon möjlighet att överblicka och där jag ändå har varit djupt och nästan plågsamt medintresserad. Det arbetet kommer att vara slutfört, när'

      'Första kapitlet
      Den bok jag nu sätter mig ner att skriva måste verka meningslös på många - om jag alls vågar tänka mig, att "många" får läsa den - eftersom jag alldeles självmant, utan någons order, börjar ett sådant arbete och ändå inte själv är riktigt på det klara med vad avsikten är. Jag vill och måste, det är alltsammans. Allt mer och mer obönhörligt frågar man efter avsikten och planmässigheten i vad som göres och säges, så att helst inte ett ord ska falla på måfå - det är bara författaren till den här boken som har tvingats gå motsatta vägen, ut i det ändamålslösa. Ty fast mina år här som fånge och kemist - de måste vara över tjugu, tänker jag mig - har varit fulla nog ändå av arbete och brådska, måste det finnas något som inte tycker det är tillräckligt och som har lett och överblickat ett annat arbete inom mig, ett som jag själv inte hade någon möjlighet att överblicka och där jag ändå har varit djupt och nästan plågsamt medintresserad. Det arbetet kommer att vara slutfört, när jag väl har skrivit ner min bok. Jag inser alltså, hur förnuftsvidriga mina skriverier måste te sig inför allt rationellt och praktiskt tänkande, men jag skriver ändå.
      Kanske jag inte skulle vågat det förr. Kanske det rentav är fångenskapen, som har gjort mig lättsinnig. Mina levnadsvillkor nu skiljer sig obetydligt från dem jag levde under som fri man. Maten visade sig vara knappt märkbart sämre här - det vande man sig vid. Britsen visade sig vara något hårdare än min säng hemma i Kemistaden n:r 4 - det vande man sig vid. Jag kom något mera sällan ut i fria luften - det vande man sig också vid. Värst var skilsmässan från min hustru och mina barn, särskilt som jag ingenting visste eller vet om deras öde; det gjorde mina första år i fångenskapen fulla av oro och ångest. Men allteftersom tiden led, började jag känna mig lugnare än förr och till och med trivas mer och mer med min tillvaro. Här hade jag ingenting att vara ängslig för. Jag hade varken underordnade eller chefer - så när som på fängelsevakterna, som sällan störde mitt arbete och bara bekymrade sig om att jag efterlevde ordningsreglerna. Jag hade varken beskyddare eller medtävlare. De vetenskapsmän jag ibland sammanfördes med för att kunna följa med nya rön på kemins område, behandlade mig hövligt och sakligt, om än något nedlåtande för min främmande nationalitets skull. Jag visste, att ingen ansåg sig ha skäl att avundas mig. Kort sagt: på sätt och vis kunde jag känna mig friare än i friheten. Men på samma gång som lugnet växte också detta underliga arbete med det förflutna inom mig, och nu får jag ingen ro förrän jag har skrivit ner mina minnen från en viss innehållsrik tid i mitt liv. Möjlighet att skriva har man givit mig för mitt vetenskapliga arbetes skull, och kontroll utövas först i det ögonblick jag lämnar ett färdigt arbete ifrån mig. Jag kan alltså kosta på mig detta enda nöje, även om det skulle bli det sista jag fick tillfälle till.
      Vid den tid då min berättelse börjar närmade jag mig de fyrti. Om jag för övrigt bör presentera mig, kan jag kanske tala om under vilken bild jag tänkte mig livet. Det finns få saker som säger mer om en människa än hennes bild av livet: om hon ser det som en väg, ett fältslag, ett växande träd eller ett rullande hav. För min del såg jag det med en snäll skolgosses ögon som en trappa, där man skyndade från avsats till avsats så fort man kunde, med flämtande andetag och medtävlaren i hälarna. I själva verket hade jag inte många medtävlare. De flesta av mina arbetskamrater på laboratoriet hade förlagt hela sin ärelystnad till det militära och ansåg dagens arbete som ett tråkigt men nödvändigt avbrott i kvällarnas militärtjänstgöring. Själv skulle jag väl knappast velat tillstå för någon av dem, hur mycket mer intresserad jag var av min kemi än av min militärtjänst, fast jag visst inte var någon dålig soldat. I alla fall jagade jag fram i min trappa. Hur många trappsteg man egentligen hade att lägga bakom sig, hade jag aldrig funderat över, inte heller vad det månde finnas för härligheter på vinden. Kanske jag dimmigt föreställde mig livets hus som ett av våra vanliga stadshus, där man steg upp ur jordens innandömen och till sist kom ut på takterrassen, i fria luften, i vind och dagsljus. Vad vinden och dagsljuset skulle motsvaras av i min livsvandring, hade jag inte klart för mig. Men säkert var, att varje ny trappavsats betecknades av korta officiella meddelanden från högre ort: om en genomgången examen, ett godkänt prov, en förflyttning till ett mera betydande verksamhetsfält. Jag hade också en hel rad sådana livsviktiga slut- och begynnelsepunkter bakom mig, dock inte så många att en ny skulle blekna i betydelse. Det var därför med ett stänk av feber i blodet jag kom tillbaka från det korta telefonsamtal, som meddelade att jag kunde vänta min kontrollchef dagen därpå och alltså fick börja experimentera med mänsklig materiel. I morgon således kom det slutliga eldprovet för min hittills största uppfinning.
      Jag var så uppspelt, att det föll sig svårt för mig att börja något nytt under de tio minuter som ännu återstod av arbetstiden. I stället fuskade jag en smula - jag tror nästan för första gången i mitt liv - och började ställa bort apparaterna i förtid, långsamt och försiktigt, medan jag sneglade genom glasväggarna åt båda sidor för att se om någon gav akt på mig. Så fort signalklockan förkunnade att arbetet var slut för dagen, skyndade jag ut genom de långa laboratoriekorridorerna som en av de första i strömmen. Hastigt duschade jag, bytte arbetskläderna mot fritidsuniformen, sprang in i paternosterhissen och stod efter några ögonblick uppe på gatan. Eftersom vi fått vår bostad i mitt arbetsdistrikt, hade vi nämligen ovanjordslicens där, och jag njöt alltid av att sträcka på mig i det fria.
      Då jag kom förbi metrostationen, föll det mig in att jag kunde vänta på Linda. Eftersom jag var så tidig, hade hon säkert inte hunnit hem än från sin livsmedelsfabrik drygt tjugu minuters metroväg därifrån. Ett tåg hade nyss kommit, och en flod av människor vällde upp ur jorden, pressades genom spärren, där ovanjordslicenserna kontrollerades, och sipprade ut över gatorna runtomkring. Över de nu tomma takterrasserna, över alla de hoprullade bergsgråa och ängsgröna presenningarna, som på tio minuter kunde göra staden osynlig från luften, betraktade jag hela den myllrande skaran av hemvändande medsoldater i fritidsuniform, och det slog mig plötsligt, att kanske alla dessa bar på samma dröm som jag: drömmen om uppåtvägen.
      Tanken grep mig. Jag visste, att förr, under den civilistiska epoken, hade människorna måst lockas till arbete och ansträngning genom hopp om rymligare bostäder, läckrare mat och vackrare kläder. Numera behövdes ingenting sådant. Standardvåningen - ett rum för de ogifta, två för familj - räckte gott åt alla, från de ringaste till de mest förtjänta. Huskökets mat gav mättnad åt generalen likaväl som åt den menige. Den allmänna uniformen - en för arbetet, en för fritiden och en för militär- och polistjänsten - var lika för alla, för man och kvinna, och för hög och låg sånär som på gradbeteckningen. Till och med den senare var egentligen inte grannare för den ene än för den andre. Det eftersträvansvärda i en högre chefsbeteckning låg enbart i vad den symboliserade. Så högt förandligad, tänkte jag lycklig, är faktiskt varenda medsoldat i Världsstaten, att det han anar som livets högsta värde knappast har någon mera konkret form för honom än tre svarta slingor på ärmen - tre svarta slingor, som är honom en pant både på egen självaktning och aktning från andras sida. Av materiella njutningar kan man säkert få nog och mer än nog - just därför misstänker jag att de gamla civilistiska kapitalisternas tolvrumsvåningar knappt heller var mer än en symbol - men detta subtilaste av allt, som man jagar under formen av gradbeteckningar, det gör ingen övermätt. Ingen kan ha så mycket aktning och så mycket självaktning, att han inte vill ha mer. På det mest förandligade, det mest luftiga och ouppnåeliga av allt vilar vår fasta samhällsordning trygg för alla tider.
      Så stod jag i funderingar vid metrons uppgång och såg som i en dröm vakten gå fram och tillbaka längs den taggtrådskrönta distriktsmuren. Fyra tåg hade kommit, fyra gånger hade skarorna strömmat upp i dagsljuset, då äntligen Linda passerade spärren. Jag skyndade fram till henne och vi fortsatte sida vid sida.
      Tala kunde vi naturligtvis inte för luftflottans övningar, som varken dag eller natt tillät något samtal att föras utomhus. I alla fall såg hon min glada min och nickade uppmuntrande, fast allvarlig som alltid. Inte förrän vi hunnit in i bostadshuset och hissen förde oss ner till vår våning, slöt sig en relativ tystnad omkring oss - metrobullret, som skakade väggarna, var inte starkare än att man kunde tala obehindrat - och ändå uppsköt vi försiktigtvis alla samtal, tills vi kommit in. Hade någon kommit på oss med att tala i hissen, skulle ju ingen misstanke varit naturligare än att vi dryftade ämnen som vi inte ville låta barnen eller hembiträdet höra. Sådana fall hade inträffat, då statsfiender och andra förbrytare velat använda hissen som konspirationslokal; det låg ju också nära till hands, eftersom polisöra och polisöga av tekniska skäl inte kunde monteras i en hiss och eftersom portvakten brukade ha annat att göra än springa och lyssna i trappnedgångarna. Vi teg alltså försiktigt ända tills vi stigit in i familjerummet, där veckans hembiträde redan dukat fram kvällsmaten och väntade med barnen, som hon hämtat ner ur husets barnvåning. Hon föreföll att vara en ordentlig och hygglig flicka, och vår vänliga hälsning berodde alltså inte bara på medvetandet om att hon, som alla hembiträden, var skyldig att avlägga rapport om familjen vid veckans slut - en reform, som allmänt ansågs ha förbättrat tonen i många hem. En stämning av glädje och trevnad rådde kring vårt bord, särskilt som vår äldste son, Ossu, var med bland oss andra. Han hade kommit på besök från barnlägret, eftersom det v '
    end
    def text() do
      'Första kapitlet
      Den bok jag nu sätter mig ner att skriva måste verka meningslös på många - om jag alls vågar tänka mig, att "många" får läsa den - eftersom jag alldeles självmant, utan någons order, börjar ett sådant arbete och ändå inte själv är riktigt på det klara med vad avsikten är. Jag vill och måste, det är alltsammans. Allt mer och mer obönhörligt frågar man efter avsikten och planmässigheten i vad som göres och säges, så att helst inte ett ord ska falla på måfå - det är bara författaren till den här boken som har tvingats gå motsatta vägen, ut i det ändamålslösa. Ty fast mina år här som fånge och kemist - de måste vara över tjugu, tänker jag mig - har varit fulla nog ändå av arbete och brådska, måste det finnas något som inte tycker det är tillräckligt och som har lett och överblickat ett annat arbete inom mig, ett som jag själv inte hade någon möjlighet att överblicka och där jag ändå har varit djupt och nästan plågsamt medintresserad. Det arbetet kommer att vara slutfört, när jag väl har skrivit ner min bok. Jag inser alltså, hur förnuftsvidriga mina skriverier måste te sig inför allt rationellt och praktiskt tänkande, men jag skriver ändå.
      Kanske jag inte skulle vågat det förr. Kanske det rentav är fångenskapen, som har gjort mig lättsinnig. Mina levnadsvillkor nu skiljer sig obetydligt från dem jag levde under som fri man. Maten visade sig vara knappt märkbart sämre här - det vande man sig vid. Britsen visade sig vara något hårdare än min säng hemma i Kemistaden n:r 4 - det vande man sig vid. Jag kom något mera sällan ut i fria luften - det vande man sig också vid. Värst var skilsmässan från min hustru och mina barn, särskilt som jag ingenting visste eller vet om deras öde; det gjorde mina första år i fångenskapen fulla av oro och ångest. Men allteftersom tiden led, började jag känna mig lugnare än förr och till och med trivas mer och mer med min tillvaro. Här hade jag ingenting att vara ängslig för. Jag hade varken underordnade eller chefer - så när som på fängelsevakterna, som sällan störde mitt arbete och bara bekymrade sig om att jag efterlevde ordningsreglerna. Jag hade varken beskyddare eller medtävlare. De vetenskapsmän jag ibland sammanfördes med för att kunna följa med nya rön på kemins område, behandlade mig hövligt och sakligt, om än något nedlåtande för min främmande nationalitets skull. Jag visste, att ingen ansåg sig ha skäl att avundas mig. Kort sagt: på sätt och vis kunde jag känna mig friare än i friheten. Men på samma gång som lugnet växte också detta underliga arbete med det förflutna inom mig, och nu får jag ingen ro förrän jag har skrivit ner mina minnen från en viss innehållsrik tid i mitt liv. Möjlighet att skriva har man givit mig för mitt vetenskapliga arbetes skull, och kontroll utövas först i det ögonblick jag lämnar ett färdigt arbete.'
    end
    #def test do
    #  sample = sample()
    #  tree = tree(sample)
    #  encode = encode_table(tree)
    #  #decode = decode_table(tree)
    #  #text = text()
    #  #seq = encode(text, encode)
    #  #decode(seq, decode)
    #end

    def tree(sample) do
      freq = freq(sample)
      huffman(freq)
    end

    def freq(sample) do
      freq(sample, [])
    end

    def freq([], freq) do
      freq
    end

    def freq([char | rest], freq) do
      freq(rest, increaseFreq(char, freq))
    end


    def increaseFreq(char, []) do
      [{char, 1}]
    end

    def increaseFreq(char, [{char, x} | rest]) do
      [{char, x + 1} | rest]
    end

    def increaseFreq(char, [other | rest]) do
      [other | increaseFreq(char, rest)]
    end


    def huffman(freq) do
      huffmanTree(Enum.sort(freq, fn({_, x}, {_, y}) -> x < y end))
    end

    def huffmanTree([{tree, _}]) do
      tree
    end

    def huffmanTree([{a, af}, {b, bf} | rest]=baba) do
      huffmanTree(insert({{a,b}, af + bf}, rest))
    end

    def insert({a, af}, []) do
      [{a, af}]
    end

    def insert({a, af}, [{b, bf} | rest]) do
      cond do
        af < bf -> [{a, af}, {b, bf} | rest]
        true -> [{b, bf} | insert({a, af}, rest)]
      end
    end

    def encode_table(tree) do
      codes(tree, [])
    end

    def codes({left, right}, list) do
      codes(left, [0 | list]) ++ codes(right, [1 | list])
    end

    def codes(a, code) do
      [{a, Enum.reverse(code)}]
    end

    def encode([], _) do
      []
    end

    def encode([char | rest], table) do
      {_, code} = List.keyfind(table, char, 0)
      code ++ encode(rest, table)
    end

    def decode_table(tree) do
      codes(tree, [])

    end
    def decode([], _) do
      []
    end
    def decode(seq, table) do
      {char, rest} = decode_char(seq, 1, table)
      [char | decode(rest, table)]
    end
    def decode_char(seq, n, table) do
      {code, rest} = Enum.split(seq, n)
      case List.keyfind(table, code, 1) do
        {char, _} -> {char, rest};
        nil -> decode_char(seq, n + 1, table)
      end
    end


     # This is the benchmark of the single operations in the
  # Huffman encoding and decoding process.


  def bench() do
    {tree, treeTime} = timer(fn -> tree(sample) end)
    IO.inspect length(sample), label: "Sample in bytes "
    {encode, encodeTableTime} = timer(fn -> encode_table(tree) end)
    {decode, decodeTableTime} = timer(fn -> decode_table(tree) end)
    {encoded, encodeTime} = timer(fn -> encode(sample, encode) end)
    IO.inspect div(length(encoded), 8), label: "Compresses sample in bytes "
    IO.puts("Time to create tree: #{encodeTableTime} ms")
    IO.puts("Time to encode_table: #{encodeTableTime} ms")
    IO.puts("Time to decode_table: #{decodeTableTime} ms")
    IO.puts("Time to encode: #{encodeTime} ms")
  end

  # Measure the execution time of a function.
  def timer(func) do
    initial = Time.utc_now()
    result = func.()
    final = Time.utc_now()
    {result, Time.diff(final, initial, :microsecond) / 1000}
  end



   # Get a suitable chunk of text to encode.
   def read(file, n) do
    {:ok, fd} = File.open(file, [:read, :utf8])
     binary = IO.read(fd, n)
     File.close(fd)

     length = byte_size(binary)
     case :unicode.characters_to_list(binary, :utf8) do
       {:incomplete, chars, rest} ->
         {chars, length - byte_size(rest)}
       chars ->
         {chars, length}
     end
   end

    def read(file) do
      {:ok, file} = File.open(file, [:read, :utf8])
      binary = IO.read(file, :all)
      File.close(file)
      case :unicode.characters_to_list(binary, :utf8) do
        {:incomplete, list, _} -> list
      list -> list
      end
    end
end
